<!DOCTYPE html><html><head><title>日志小助手——使用指南</title><meta charset='utf-8'><link href='https://dn-maxiang.qbox.me/res-min/themes/marxico.css' rel='stylesheet'><style></style></head><body><div id='preview-contents' class='note-content'>
                        
                    



<h1 id="日志小助手使用指南">日志小助手——使用指南</h1>

<p> <br>
[TOC]</p>



<h2 id="git-wiki-maven">Git &amp; Wiki &amp; Maven</h2>

<p><a href="http://gitlab.corp.qunar.com/guohang.ding/common_util" target="_blank">GitLab: Common_Util</a> <br>
<a href="http://wiki.corp.qunar.com/pages/viewpage.action?pageId=138710608" target="_blank">Wiki: 日志小组件</a></p>



<pre class="prettyprint hljs-dark"><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>com.qunar.guohang<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>common_util<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span><br></code></pre>

<h2 id="message">Message</h2>

<blockquote>
  <h2 id="logservice-logutil">LogService / LogUtil</h2>
  
  <p>1、日志参数序列化 <br>
  2、isXXXEnabled</p>
  
  <h2 id="logperformance">@LogPerformance</h2>
  
  <p>1、记录方法耗时，记录流程块耗时 <br>
  2、通过实现MethodFilter进行监控扩展，使用exclusion属性进行filter的屏蔽 <em>//这个在考虑是否做成SPI</em></p>
</blockquote>



<pre class="prettyprint hljs-dark"><code class="language-java hljs"><span class="hljs-comment">/**<br> * 关注性能<br> * 主要关注方法耗时<br> * &lt;p&gt;<br> * 可以配置流程块，监控关注的流程块的耗时<br> * 注意：只关注【流程块】中方法（配置了注解）的耗时，不关注【流程】中其它方法的耗时<br> * &lt;p&gt;<br> * 允许一次请求中出现多个流程块重叠，但是某个方法只能作为某一个流程块的成员 -&gt; 所以这个设定蛮鸡肋的<br> * 但是想象不出有什么场景需要多个流程块重叠<br> * <br> * updated by guohang.ding on 16-10-6<br> * 通过实现MethodFilter进行监控扩展，使用exclusion属性进行filter的屏蔽<br> *<br> * <span class="hljs-doctag">@author</span> guohang.ding on 16-10-2<br> */</span><br><span class="hljs-annotation">@Inherited</span><br><span class="hljs-annotation">@Target</span>(ElementType.METHOD)<br><span class="hljs-annotation">@Retention</span>(RetentionPolicy.RUNTIME)<br><span class="hljs-keyword">public</span> <span class="hljs-annotation">@interface</span> LogPerformance {<br><br>    <span class="hljs-comment">/** 流程块，默认不关注流程块 */</span><br>    <span class="hljs-function">String <span class="hljs-title">flow</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> ""</span>;<br><br>    <span class="hljs-comment">/** 该方法是否是流程块最后一个方法 */</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">finish</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">true</span></span>;<br><br>    <span class="hljs-comment">/** 该方法不使用哪些Filter进行监控 */</span><br>    Class&lt;? extends MethodFilter&gt;[] exclusion() <span class="hljs-keyword">default</span> {};<br>}<br></code></pre>

<blockquote>
  <h2 id="注意">注意</h2>
  
  <p>Spring扫描包一定要包含jar的目录</p>
</blockquote>

<h2 id="demo">Demo</h2>



<pre class="prettyprint hljs-dark"><code class="language-java hljs"><span class="hljs-comment">/**<br> * <span class="hljs-doctag">@author</span> guohang.ding on 16-10-4<br> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">InterfaceDemo</span> </span>{<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">aMethod</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">bMethod</span><span class="hljs-params">()</span></span>;<br>}<br><br><span class="hljs-comment">/**<br> * <span class="hljs-doctag">@author</span> guohang.ding on 16-10-4<br> */</span><br><span class="hljs-annotation">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceDemo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InterfaceDemo</span></span>{<br><br>    <span class="hljs-annotation">@LogPerformance</span>(flow = <span class="hljs-string">"aFlow"</span>, finish = <span class="hljs-keyword">false</span>)<br>    <span class="hljs-annotation">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">aMethod</span><span class="hljs-params">()</span> </span>{<br>        System.out.println(<span class="hljs-string">"in a"</span>);<br>        System.out.println(<span class="hljs-string">"out of a"</span>);<br>    }<br><br>    <span class="hljs-annotation">@LogPerformance</span>(flow = <span class="hljs-string">"aFlow"</span>)<br>    <span class="hljs-annotation">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">bMethod</span><span class="hljs-params">()</span> </span>{<br>        System.out.println(<span class="hljs-string">"in b"</span>);<br>        SleepUtil.sleep(<span class="hljs-number">3000</span>);<br>        System.out.println(<span class="hljs-string">"out of b"</span>);<br>    }<br>}<br><br><span class="hljs-comment">/**<br> * <span class="hljs-doctag">@author</span> guohang.ding on 16-10-4<br> */</span><br><span class="hljs-annotation">@RunWith</span>(SpringJUnit4ClassRunner.class)<br><span class="hljs-annotation">@ContextConfiguration</span>(locations = {<span class="hljs-string">"classpath:test-spring-2.xml"</span>})<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceDemoTest</span> </span>{<br><br>    <span class="hljs-annotation">@Resource</span><br>    InterfaceDemo serviceDemo;<br><br>    <span class="hljs-annotation">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test01</span><span class="hljs-params">()</span> </span>{<br>        serviceDemo.aMethod();<br>        serviceDemo.bMethod();<br>    }<br>}<br>{code}<br></code></pre></div></body></html>